// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVER.JS - Ğ“Ğ›ĞĞ’ĞĞ«Ğ™ Ğ¤ĞĞ™Ğ› BACKEND Ğ¡Ğ•Ğ Ğ’Ğ•Ğ Ğ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECURITY FEATURES:
// âœ… Helmet.js - Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° HTTP Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ²
// âœ… Rate Limiting - Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ DDoS Ğ¸ bruteforce
// âœ… CORS Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾
// âœ… Input validation
// âœ… Error handling
//
// TODO Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°:
// â³ HTTPS/SSL (AWS)
// â³ Email verification (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ SMTP)
// â³ 2FA (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ SMS/Authenticator)
// â³ WAF (AWS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

require('dotenv').config(); // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ .env Ğ² ÑĞ°Ğ¼Ğ¾Ğ¼ Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ!

const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const rateLimit = require('express-rate-limit');
const { PrismaClient } = require('@prisma/client');

const app = express();
const prisma = new PrismaClient();
const PORT = process.env.PORT || 3000;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SECURITY MIDDLEWARE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 1. Helmet - Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° HTTP Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ²
app.use(helmet());

// 2. CORS - Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾
const corsOptions = {
  origin: process.env.ALLOWED_ORIGINS 
    ? process.env.ALLOWED_ORIGINS.split(',') 
    : ['http://localhost:19006', 'http://localhost:8081'], // Expo dev URLs
  credentials: true,
  optionsSuccessStatus: 200
};
app.use(cors(corsOptions));

// 3. Rate Limiting - Ğ¾Ğ±Ñ‰Ğ¸Ğ¹ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  max: 100, // ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 100 Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ğ·Ğ° 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  message: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ IP, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾Ğ·Ğ¶Ğµ',
  standardHeaders: true,
  legacyHeaders: false,
});
app.use(generalLimiter);

// 4. Rate Limiting Ğ´Ğ»Ñ auth endpoints (Ğ±Ğ¾Ğ»ĞµĞµ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¸Ğ¹)
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  max: 5, // ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ 5 Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ğ·Ğ° 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚
  message: 'Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ¾Ğº Ğ²Ñ…Ğ¾Ğ´Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ Ñ‡ĞµÑ€ĞµĞ· 15 Ğ¼Ğ¸Ğ½ÑƒÑ‚',
  skipSuccessfulRequests: true, // ĞĞµ ÑÑ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸
  standardHeaders: true,
  legacyHeaders: false,
});

// 5. JSON parsing Ñ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ¾Ğ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ° (Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ğ° Ğ¾Ñ‚ JSON bomb)
app.use(express.json({ limit: '10mb' }));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const authRoutes = require('./routes/auth');
const eventsRoutes = require('./routes/events');
const likesRoutes = require('./routes/likes');
const commentsRoutes = require('./routes/comments');

// Auth routes Ñ rate limiting
app.use('/api/auth', authLimiter, authRoutes);

// ĞÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ routes
app.use('/api/events', eventsRoutes);
app.use('/api/likes', likesRoutes);
app.use('/api/comments', commentsRoutes);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEALTH CHECK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.get('/', (req, res) => {
  res.json({ 
    message: 'KULA API Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚! ğŸš€',
    version: '1.0.0',
    security: {
      helmet: 'âœ…',
      rateLimit: 'âœ…',
      cors: 'âœ…',
      validation: 'âœ…'
    },
    endpoints: {
      auth: '/api/auth',
      events: '/api/events',
      likes: '/api/likes',
      comments: '/api/comments'
    }
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ERROR HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 404 handler
app.use((req, res) => {
  res.status(404).json({ 
    error: 'Endpoint Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½',
    path: req.path 
  });
});

// Global error handler
app.use((err, req, res, next) => {
  console.error('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°:', err);
  
  // ĞĞµ Ñ€Ğ°ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ² production
  const isDev = process.env.NODE_ENV !== 'production';
  
  res.status(err.status || 500).json({ 
    error: 'Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°',
    ...(isDev && { message: err.message, stack: err.stack })
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SERVER START
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

app.listen(PORT, () => {
  console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   ğŸš€ KULA Backend Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!             â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘   ĞŸĞ¾Ñ€Ñ‚: ${PORT}                        â•‘
â•‘   URL: http://localhost:${PORT}        â•‘
â•‘                                        â•‘
â•‘   ğŸ” Security:                         â•‘
â•‘   âœ… Helmet.js                         â•‘
â•‘   âœ… Rate Limiting                     â•‘
â•‘   âœ… CORS                              â•‘
â•‘   âœ… Input Validation                  â•‘
â•‘                                        â•‘
â•‘   ğŸ“‹ TODO Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ°:              â•‘
â•‘   â³ HTTPS/SSL                         â•‘
â•‘   â³ Email Verification                â•‘
â•‘   â³ 2FA                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRACEFUL SHUTDOWN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

process.on('SIGINT', async () => {
  console.log('\nğŸ‘‹ ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€...');
  await prisma.$disconnect();
  process.exit(0);
});

process.on('SIGTERM', async () => {
  console.log('\nğŸ‘‹ ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑĞµÑ€Ğ²ĞµÑ€...');
  await prisma.$disconnect();
  process.exit(0);
});