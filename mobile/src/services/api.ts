// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API SERVICE - Ğ¦Ğ•ĞĞ¢Ğ ĞĞ›Ğ˜Ğ—ĞĞ’ĞĞĞĞĞ¯ Ğ ĞĞ‘ĞĞ¢Ğ Ğ¡ BACKEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ•Ğ´Ğ¸Ğ½Ğ¾Ğµ Ğ¼ĞµÑÑ‚Ğ¾ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… API Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
// ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾Ğ´ÑÑ‚Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ URL Ğ´Ğ»Ñ ÑĞ¼ÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğ°/ÑĞ¸Ğ¼ÑƒĞ»ÑÑ‚Ğ¾Ñ€Ğ°
// ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ Ğ¿Ñ€Ğ¸ Ğ¸ÑÑ‚ĞµÑ‡ĞµĞ½Ğ¸Ğ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import axios from 'axios';
import { Platform } from 'react-native';
import { 
  getAccessToken, 
  getRefreshToken, 
  saveAccessToken,
  removeTokens 
} from './auth';

// ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ API URL
const getApiUrl = () => {
  if (Platform.OS === 'android') {
    // Android ÑĞ¼ÑƒĞ»ÑÑ‚Ğ¾Ñ€
    return 'http://10.0.2.2:3000/api';
  } else if (Platform.OS === 'ios') {
    // iOS ÑĞ¸Ğ¼ÑƒĞ»ÑÑ‚Ğ¾Ñ€
    return 'http://localhost:3000/api';
  } else {
    // Web
    return 'http://localhost:3000/api';
  }
};

export const API_URL = getApiUrl();

console.log('ğŸ“¡ API URL:', API_URL);

// Axios instance Ñ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¼Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸
const apiClient = axios.create({
  baseURL: API_URL,
  timeout: 10000,
  headers: {
    'Content-Type': 'application/json',
  },
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERCEPTOR: ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ• Ğ”ĞĞ‘ĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ACCESS TOKEN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
apiClient.interceptors.request.use(
  async (config) => {
    const token = await getAccessToken();
    if (token && config.headers) {
      config.headers.Authorization = `Bearer ${token}`;
    }
    return config;
  },
  (error) => Promise.reject(error)
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INTERCEPTOR: ĞĞ’Ğ¢ĞĞœĞĞ¢Ğ˜Ğ§Ğ•Ğ¡ĞšĞĞ• ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• Ğ¢ĞĞšĞ•ĞĞ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let isRefreshing = false;
let failedQueue: any[] = [];

const processQueue = (error: any, token: string | null = null) => {
  failedQueue.forEach((prom) => {
    if (error) {
      prom.reject(error);
    } else {
      prom.resolve(token);
    }
  });
  failedQueue = [];
};

apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    const originalRequest = error.config;

    // Ğ•ÑĞ»Ğ¸ 401 Ğ¸ ÑÑ‚Ğ¾ Ğ½Ğµ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ
    if (error.response?.status === 401 && !originalRequest._retry) {
      if (isRefreshing) {
        // Ğ•ÑĞ»Ğ¸ ÑƒĞ¶Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½ - Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ
        return new Promise((resolve, reject) => {
          failedQueue.push({ resolve, reject });
        })
          .then((token) => {
            originalRequest.headers.Authorization = `Bearer ${token}`;
            return apiClient(originalRequest);
          })
          .catch((err) => Promise.reject(err));
      }

      originalRequest._retry = true;
      isRefreshing = true;

      try {
        const refreshToken = await getRefreshToken();
        
        if (!refreshToken) {
          throw new Error('No refresh token');
        }

        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½
        const response = await axios.post(`${API_URL}/auth/refresh`, {
          refreshToken,
        });

        const { accessToken } = response.data;
        await saveAccessToken(accessToken);

        // ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ¾Ğº
        apiClient.defaults.headers.common.Authorization = `Bearer ${accessToken}`;
        originalRequest.headers.Authorization = `Bearer ${accessToken}`;

        processQueue(null, accessToken);
        
        return apiClient(originalRequest);
      } catch (err) {
        processQueue(err, null);
        await removeTokens();
        
        // Ğ—Ğ´ĞµÑÑŒ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ´Ğ¸Ñ€ĞµĞºÑ‚ Ğ½Ğ° Ğ»Ğ¾Ğ³Ğ¸Ğ½
        // ĞĞ¾ Ğ² React Native ÑÑ‚Ğ¾ ÑĞ»Ğ¾Ğ¶Ğ½ĞµĞµ Ñ‡ĞµĞ¼ Ğ² web
        // ĞŸĞ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ¾Ñ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ñ‚Ğ¾ĞºĞµĞ½Ñ‹
        
        return Promise.reject(err);
      } finally {
        isRefreshing = false;
      }
    }

    return Promise.reject(error);
  }
);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API Ğ”Ğ›Ğ¯ ĞĞ’Ğ¢ĞĞ Ğ˜Ğ—ĞĞ¦Ğ˜Ğ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export const authAPI = {
  login: async (email: string, password: string) => {
    const response = await apiClient.post('/auth/login', { email, password });
    return response.data;
  },

  register: async (username: string, email: string, password: string) => {
    const response = await apiClient.post('/auth/register', {
      username,
      email,
      password,
    });
    return response.data;
  },

  refreshToken: async (refreshToken: string) => {
    const response = await apiClient.post('/auth/refresh', { refreshToken });
    return response.data;
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API Ğ”Ğ›Ğ¯ Ğ¡ĞĞ‘Ğ«Ğ¢Ğ˜Ğ™
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export const eventsAPI = {
  create: async (eventData: any) => {
    const response = await apiClient.post('/events', eventData);
    return response.data;
  },

  getAll: async () => {
    const response = await apiClient.get('/events');
    return response.data;
  },

  getById: async (id: string) => {
    const response = await apiClient.get(`/events/${id}`);
    return response.data;
  },

  getMy: async () => {
    const response = await apiClient.get('/events/my');
    return response.data;
  },

  delete: async (id: string) => {
    const response = await apiClient.delete(`/events/${id}`);
    return response.data;
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API Ğ”Ğ›Ğ¯ Ğ›ĞĞ™ĞšĞĞ’
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export const likesAPI = {
  toggle: async (eventId: string) => {
    const response = await apiClient.post(`/likes/${eventId}`);
    return response.data;
  },

  check: async (eventId: string) => {
    const response = await apiClient.get(`/likes/${eventId}`);
    return response.data;
  },

  getCount: async (eventId: string) => {
    const response = await apiClient.get(`/likes/${eventId}/count`);
    return response.data;
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// API Ğ”Ğ›Ğ¯ ĞšĞĞœĞœĞ•ĞĞ¢ĞĞ Ğ˜Ğ•Ğ’
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
export const commentsAPI = {
  add: async (eventId: string, text: string) => {
    const response = await apiClient.post(`/comments/${eventId}`, { text });
    return response.data;
  },

  getAll: async (eventId: string) => {
    const response = await apiClient.get(`/comments/${eventId}`);
    return response.data;
  },

  delete: async (commentId: string) => {
    const response = await apiClient.delete(`/comments/${commentId}`);
    return response.data;
  },

  getCount: async (eventId: string) => {
    const response = await apiClient.get(`/comments/${eventId}/count`);
    return response.data;
  },
};

export default apiClient;